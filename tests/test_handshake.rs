/// Three-way handshake test
/// 1. Client sends PING command
/// 2. Client sends REPLCONF listening-port command as follows:
///    *3\r\n$8\r\nREPLCONF\r\n$14\r\nlistening-port\r\n{len-of-client-port}\r\n{client-port}\r\n
/// 3. Client sends REPLCONF capa command as follows:
///    *3\r\n$8\r\nREPLCONF\r\n$4\r\ncapa\r\n$6\r\npsync2\r\n
/// 4. Client send PSYNC command as follows:
///    *3\r\n$5\r\nPSYNC\r\n$1\r\n?\r\n$2\r\n-1\r\n
use common::{spawn_server_as_slave, spawn_server_process};
use duva::client_utils::ClientStreamHandler;


mod common;

#[tokio::test]
async fn test_master_threeway_handshake() {
    // GIVEN - master server configuration
    let process = spawn_server_process();
    let mut h = ClientStreamHandler::new(format!("127.0.0.1:{}", process.port() + 10000)).await;

    // Case 1 - client sends PING command
    assert_eq!(h.send_and_get(b"*1\r\n$4\r\nPING\r\n").await, "+PONG\r\n");

    // Case 2 - client sends REPLCONF listening-port command
    let client_fake_port = 6778;
    assert_eq!(
        h.send_and_get(
            format!(
                "*3\r\n$8\r\nREPLCONF\r\n$14\r\nlistening-port\r\n$4\r\n{client_fake_port}\r\n",
            )
                .as_bytes(),
        )
            .await,
        "+OK\r\n"
    );

    // Case3 - client sends REPLCONF capa command
    assert_eq!(
        h.send_and_get(b"*3\r\n$8\r\nREPLCONF\r\n$4\r\ncapa\r\n$6\r\npsync2\r\n").await,
        "+OK\r\n"
    );

    // WHEN - client sends PSYNC command
    // ! The first argument is the replication ID of the master
    // ! Since this is the first time the replica is connecting to the master, the replication ID will be ? (a question mark)
    let response = h
        .send_and_get(b"*3\r\n$5\r\nPSYNC\r\n$1\r\n?\r\n$2\r\n-1\r\n")
        .await;

    let split: Vec<&str> = response.split(' ').collect();
    assert_eq!(split[0], "+FULLRESYNC");
    assert_eq!(split[1].len(), 40); // replid length == 40
    assert_eq!(split[2].len(), 3); // offset(1) + \r\n(2)
}

#[tokio::test]
async fn test_slave_threeway_handshake() {
    // GIVEN - master server configuration
    // Find free ports for the master and replica
    let master_process = spawn_server_process();

    // WHEN run replica
    let mut replica_process = spawn_server_as_slave(&master_process);

    // Read stdout from the replica process
    replica_process.wait_for_message("[INFO] Three-way handshake completed", 1).unwrap();
}
